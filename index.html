<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budgeting!</title>
    <link rel="icon" type="image/png" href="Images/favicon_1.png">
    <link rel="stylesheet" href="Styles/IndexStyles.css">
</head>
<body>
    <!-- Main page heading  -->
    <h1>Budget time!</h1>

    <!-- Google API Sign-In Section -->
    <div>
        <h1>Sign In to Your Account</h1>
        <div id="g_signin2"></div>

        <!-- Button that stays disabled until sign-in -->
        <button id="redirectButton" disabled style="opacity: 0.5; cursor: not-allowed; margin-top: 20px;">
            Continue to Budget Table
        </button>
    </div>

    <!-- Google Identity Services Script -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Custom JavaScript for Google Sign-In -->
    <script>
        function handleCredentialResponse(response) {
            const id_token = response.credential;
            console.log(id_token);

            fetch('http://localhost:3001/verify-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: id_token }),
            })
            .then((res) => res.json())
            .then((data) => {
                console.log('User data:', data);

                if (data.message === 'User found' || data.message === 'User created') {
                    // Enable the redirect button
                    const btn = document.getElementById('redirectButton');
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';

                    // Add event listener for redirection
                    btn.addEventListener('click', () => {
                        window.location.href = 'budget-table.html';
                    });
                } else {
                    console.error('User not found or error in user creation:', data);
                }
            })
            .catch((error) => {
                console.error('Error during token verification:', error);
            });
        }

        window.onload = function () {
            google.accounts.id.initialize({
                client_id: '457823584077-c1td3bd3i5c6itoki7kcclc04id31bhp.apps.googleusercontent.com',
                callback: handleCredentialResponse,
            });

            google.accounts.id.renderButton(
                document.getElementById('g_signin2'),
                { theme: 'outline', size: 'large' }
            );

            google.accounts.id.prompt();
        };
    </script>

    <!-- Save Data Button (left unchanged for your backend work) -->
    <button id="saveButton">Save Data</button>

    <script>
        document.getElementById('saveButton').addEventListener('click', () => {
            fetch('http://localhost:3001/save-table', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    rows: [
                        { column1_name: 'value1', column2_name: 123 },
                        { column1_name: 'value2', column2_name: 456 }
                    ]
                })
            })
            .then(response => response.json())
            .then(data => console.log('Data saved:', data))
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
